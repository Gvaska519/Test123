<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectHub - Chat, Call & Screen Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        .dark-gradient-bg {
            background: linear-gradient(135deg, #4b5563, #1f2937);
        }
        .verified-badge {
            color: #3b82f6;
            font-size: 0.8em;
            margin-left: 2px;
        }
        .rank-owner {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        .rank-admin {
            color: #ef4444;
            font-weight: bold;
        }
        .rank-moderator {
            color: #10b981;
            font-weight: bold;
        }
        .rank-tester {
            color: #3b82f6;
            font-weight: bold;
        }
        .rank-banned {
            color: #6b7280;
            text-decoration: line-through;
        }
        .floating-notification {
            animation: floatUp 0.5s ease-out forwards;
        }
        @keyframes floatUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .dark-mode {
            background-color: #1a202c;
            color: #f7fafc;
        }
        .dark-mode-bg {
            background-color: #2d3748;
        }
        .dark-mode-text {
            color: #f7fafc;
        }
        .dark-mode-border {
            border-color: #4a5568;
        }
        .dark-mode-input {
            background-color: #2d3748;
            color: #f7fafc;
            border-color: #4a5568;
        }
        .dark-mode-card {
            background-color: #2d3748;
            color: #f7fafc;
            border-color: #4a5568;
        }
        .chat-container {
            height: calc(100vh - 120px);
        }
        .messages-container {
            height: calc(100% - 60px);
            overflow-y: auto;
        }
        .friend-request-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
        .screen-sharing-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 200px;
            border: 2px solid #6e8efb;
            border-radius: 8px;
            background-color: #000;
            z-index: 90;
        }
        .screen-sharing-controls {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: rgba(0,0,0,0.7);
            padding: 5px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 90%;
            max-width: 1200px;
        }
        .video-box {
            width: 45%;
            min-width: 300px;
            height: 300px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .call-controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
        }
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .call-accept {
            background-color: #10B981;
            color: white;
        }
        .call-decline {
            background-color: #EF4444;
            color: white;
        }
        .call-end {
            background-color: #EF4444;
            color: white;
        }
        .call-mute {
            background-color: #3B82F6;
            color: white;
        }
        .call-video {
            background-color: #3B82F6;
            color: white;
        }
        .incoming-call {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .incoming-call h3 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        .incoming-call-btns {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans transition-colors duration-300">
    <!-- Auth Section -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Login Form -->
            <div id="login-form" class="bg-white rounded-lg shadow-xl overflow-hidden dark:dark-mode-card">
                <div class="gradient-bg p-6 text-white">
                    <h2 class="text-2xl font-bold">Welcome to ConnectHub</h2>
                    <p class="opacity-90">Login to start chatting and calling</p>
                </div>
                <form class="p-6 space-y-4">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Username</label>
                        <input type="text" id="login-username" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Password</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="button" onclick="showResetPassword()" class="text-sm text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300">Forgot password?</button>
                        <button type="button" onclick="handleLogin()" class="gradient-bg text-white px-4 py-2 rounded-md hover:opacity-90 transition">Login</button>
                    </div>
                </form>
                <div class="px-6 py-4 bg-gray-50 text-center dark:bg-gray-700">
                    <p class="text-sm text-gray-600 dark:text-gray-300">Don't have an account? 
                        <button onclick="showRegister()" class="text-purple-600 font-medium dark:text-purple-400">Register</button>
                    </p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden bg-white rounded-lg shadow-xl overflow-hidden dark:dark-mode-card">
                <div class="gradient-bg p-6 text-white">
                    <h2 class="text-2xl font-bold">Create Account</h2>
                    <p class="opacity-90">Join our community</p>
                </div>
                <form class="p-6 space-y-4">
                    <div>
                        <label for="reg-username" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Username</label>
                        <input type="text" id="reg-username" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                        <p id="username-error", class="text-xs text-red-500 hidden">Username already exists</p>
                    </div>
                    <div>
                        <label for="reg-password" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Password</label>
                        <input type="password" id="reg-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                    </div>
                    <div>
                        <label for="reg-confirm-password" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Confirm Password</label>
                        <input type="password" id="reg-confirm-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                        <p id="password-error" class="text-xs text-red-500 hidden">Passwords don't match</p>
                    </div>
                    <div>
                        <label for="reg-secret" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Secret Code (for password recovery)</label>
                        <input type="password" id="reg-secret" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                    </div>
                    <button type="button" onclick="handleRegister()" class="w-full gradient-bg text-white px-4 py-2 rounded-md hover:opacity-90 transition">Register</button>
                </form>
                <div class="px-6 py-4 bg-gray-50 text-center dark:bg-gray-700">
                    <p class="text-sm text-gray-600 dark:text-gray-300">Already have an account? 
                        <button onclick="showLogin()" class="text-purple-600 font-medium dark:text-purple-400">Login</button>
                    </p>
                </div>
            </div>

            <!-- Reset Password Form -->
            <div id="reset-password-form" class="hidden bg-white rounded-lg shadow-xl overflow-hidden dark:dark-mode-card">
                <div class="gradient-bg p-6 text-white">
                    <h2 class="text-2xl font-bold">Reset Password</h2>
                    <p class="opacity-90">Recover your account</p>
                </div>
                <form class="p-6 space-y-4">
                    <div>
                        <label for="reset-username" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Username</label>
                        <input type="text" id="reset-username" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                    </div>
                    <div>
                        <label for="reset-secret" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Secret Code</label>
                        <input type="password" id="reset-secret" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">New Password</label>
                        <input type="password" id="new-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                    </div>
                    <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring-1 focus:ring-purple-500 dark:dark-mode-input">
                        <p id="reset-password-error" class="text-xs text-red-500 hidden">Passwords don't match</p>
                    </div>
                    <button type="button" onclick="handleResetPassword()", class="w-full gradient-bg text-white px-4 py-2 rounded-md hover:opacity-90 transition">Reset Password</button>
                </form>
                <div class="px-6 py-4 bg-gray-50 text-center dark:bg-gray-700">
                    <button onclick="showLogin()" class="text-purple-600 font-medium dark:text-purple-400">Back to Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="main-app" class="hidden h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-users text-2xl"></i>
                    <h1 class="text-xl font-bold">ConnectHub</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <img src="https://ui-avatars.com/api/?name=User" alt="Profile" class="w-8 h-8 rounded-full">
                        <span id="current-username" class="font-medium"></span>
                        <span id="current-user-rank" class="text-xs px-2 py-1 rounded-full bg-white bg-opacity-20"></span>
                    </div>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20">
                        <i id="dark-mode-icon" class="fas fa-moon"></i>
                    </button>
                    <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <div class="w-64 bg-white border-r dark:bg-gray-800 dark:border-gray-700 flex flex-col">
                <!-- Search -->
                <div class="p-3 border-b dark:border-gray-700">
                    <div class="relative">
                        <input type="text" placeholder="Search users..." class="w-full pl-10 pr-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" id="search-users">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <!-- Friends List -->
                <div class="flex-1 overflow-y-auto">
                    <div class="p-3">
                        <h3 class="font-medium text-gray-500 dark:text-gray-400 mb-2">Friends</h3>
                        <div id="friends-list" class="space-y-2">
                            <!-- Friends will be added here dynamically -->
                        </div>
                    </div>

                    <div class="p-3 border-t dark:border-gray-700">
                        <h3 class="font-medium text-gray-500 dark:text-gray-400 mb-2">Friend Requests</h3>
                        <div id="friend-requests-list" class="space-y-2">
                            <!-- Friend requests will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Add Friend Button -->
                <div class="p-3 border-t dark:border-gray-700">
                    <button onclick="showAddFriendModal()" class="w-full gradient-bg text-white py-2 rounded-lg flex items-center justify-center space-x-2">
                        <i class="fas fa-user-plus"></i>
                        <span>Add Friend</span>
                    </button>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-700">
                <!-- Chat Header -->
                <div id="chat-header" class="p-3 border-b dark:border-gray-600 flex items-center justify-between bg-white dark:bg-gray-800">
                    <div class="flex items-center space-x-3">
                        <img id="current-chat-avatar" src="https://ui-avatars.com/api/?name=User" alt="Chat" class="w-10 h-10 rounded-full">
                        <div>
                            <h2 id="current-chat-name" class="font-medium">Select a friend to chat</h2>
                            <p id="current-chat-status" class="text-xs text-gray-500 dark:text-gray-400">Offline</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="start-video-call" onclick="startVideoCall()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" title="Video Call">
                            <i class="fas fa-video"></i>
                        </button>
                        <button id="start-screen-share" onclick="startScreenShare()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" title="Share Screen">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button id="stop-screen-share" onclick="stopScreenShare()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 hidden" title="Stop Sharing">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button onclick="showChatOptions()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="chat-container" class="chat-container flex-1 flex flex-col">
                    <div id="messages-container" class="messages-container p-4 space-y-3 overflow-y-auto">
                        <div class="text-center py-10 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-comments text-4xl mb-2"></i>
                            <p>Select a friend to start chatting</p>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="p-3 border-t dark:border-gray-600 bg-white dark:bg-gray-800">
                        <div class="flex items-center space-x-2">
                            <button class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 px-4 py-2 rounded-full border dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" disabled>
                            <button id="send-message" class="p-2 gradient-bg text-white rounded-full w-10 h-10 flex items-center justify-center" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="add-friend-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-medium">Add Friend</h3>
                <button onclick="hideAddFriendModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                    <input type="text" id="add-friend-username" class="w-full px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message (optional)</label>
                    <textarea id="add-friend-message" class="w-full px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="2"></textarea>
                </div>
            </div>
            <div class="p-4 border-t dark:border-gray-700 flex justify-end space-x-2">
                <button onclick="hideAddFriendModal()" class="px-4 py-2 border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                <button onclick="sendFriendRequest()" class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90">Send Request</button>
            </div>
        </div>
    </div>

    <!-- Friend Request Popup -->
    <div id="friend-request-popup" class="hidden friend-request-popup bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-4 border-b dark:border-gray-700">
            <h3 class="text-lg font-medium">New Friend Request</h3>
        </div>
        <div class="p-4">
            <div class="flex items-center space-x-3 mb-4">
                <img id="request-avatar" src="https://ui-avatars.com/api/?name=User" alt="User" class="w-12 h-12 rounded-full">
                <div>
                    <h4 id="request-username" class="font-medium"></h4>
                    <p id="request-message" class="text-sm text-gray-500 dark:text-gray-400">Wants to be your friend</p>
                </div>
            </div>
        </div>
        <div class="p-4 border-t dark:border-gray-700 flex justify-end space-x-2">
            <button onclick="declineFriendRequest()" class="px-4 py-2 border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Decline</button>
            <button onclick="acceptFriendRequest()" class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90">Accept</button>
        </div>
    </div>

    <!-- Screen Sharing Container -->
    <div id="screen-sharing-container" class="hidden screen-sharing-container">
        <video id="screen-sharing-video" autoplay playsinline></video>
        <div class="screen-sharing-controls">
            <button onclick="stopScreenShare()" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                <i class="fas fa-stop"></i> Stop
            </button>
        </div>
    </div>

    <!-- Video Call Container -->
    <div id="call-container" class="hidden call-container">
        <div class="video-container">
            <div class="video-box">
                <video id="local-video" autoplay playsinline muted></video>
            </div>
            <div class="video-box">
                <video id="remote-video" autoplay playsinline></video>
            </div>
        </div>
        <div class="call-controls">
            <button id="mute-btn" onclick="toggleMute()" class="call-btn call-mute">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="video-btn", onclick="toggleVideo()" class="call-btn call-video">
                <i class="fas fa-video"></i>
            </button>
            <button onclick="endCall()" class="call-btn call-end">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>

    <!-- Incoming Call Popup -->
    <div id="incoming-call" class="hidden incoming-call">
        <h3>Incoming Video Call</h3>
        <p id="caller-name">From: <span></span></p>
        <div class="incoming-call-btns">
            <button onclick="acceptCall()" class="call-btn call-accept">
                <i class="fas fa-phone"></i>
            </button>
            <button onclick="declineCall()" class="call-btn call-decline">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed bottom-4 right-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-4 max-w-xs floating-notification dark:bg-gray-700">
            <div class="flex items-start">
                <div id="notification-icon" class="mr-3 mt-1">
                    <i class="fas fa-info-circle text-blue-500"></i>
                </div>
                <div>
                    <h4 id="notification-title" class="font-medium text-gray-900 dark:text-white">Notification</h4>
                    <p id="notification-message" class="text-sm text-gray-500 dark:text-gray-300">This is a notification message.</p>
                </div>
                <button onclick="hideNotification()" class="ml-4 text-gray-400 hover:text-gray-500 dark:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // App State
        const appState = {
            users: JSON.parse(localStorage.getItem('connectHubUsers')) || [
                {
                    username: "Saba Gvasalia",
                    password: "password123",
                    secretCode: "dev123",
                    verified: true,
                    rank: "owner",
                    profilePicture: null,
                    online: true,
                    friends: ["tester1", "moderator1", "admin1"],
                    friendRequests: []
                },
                {
                    username: "tester1",
                    password: "test123",
                    secretCode: "test123",
                    verified: false,
                    rank: "tester",
                    profilePicture: null,
                    online: true,
                    friends: ["Saba Gvasalia"],
                    friendRequests: []
                },
                {
                    username: "moderator1",
                    password: "mod123",
                    secretCode: "mod123",
                    verified: true,
                    rank: "moderator",
                    profilePicture: null,
                    online: false,
                    friends: ["Saba Gvasalia", "admin1"],
                    friendRequests: []
                },
                {
                    username: "admin1",
                    password: "admin123",
                    secretCode: "admin123",
                    verified: true,
                    rank: "admin",
                    profilePicture: null,
                    online: true,
                    friends: ["Saba Gvasalia", "moderator1"],
                    friendRequests: []
                },
                {
                    username: "user1",
                    password: "user123",
                    secretCode: "user123",
                    verified: false,
                    rank: "user",
                    profilePicture: null,
                    online: false,
                    friends: [],
                    friendRequests: ["Saba Gvasalia"]
                },
                {
                    username: "banned1",
                    password: "banned123",
                    secretCode: "banned123",
                    verified: false,
                    rank: "banned",
                    profilePicture: null,
                    online: false,
                    friends: [],
                    friendRequests: []
                }
            ],
            currentUser: null,
            darkMode: localStorage.getItem('darkMode') === 'true',
            currentChat: null,
            messages: JSON.parse(localStorage.getItem('connectHubMessages')) || {
                "Saba Gvasalia:tester1": [
                    { sender: "Saba Gvasalia", text: "Hey tester!", timestamp: new Date(Date.now() - 3600000) },
                    { sender: "tester1", text: "Hi Saba! How are you?", timestamp: new Date(Date.now() - 3500000) },
                    { sender: "Saba Gvasalia", text: "I'm good, thanks! Working on the new chat feature.", timestamp: new Date(Date.now() - 3400000) }
                ],
                "Saba Gvasalia:moderator1": [
                    { sender: "Saba Gvasalia", text: "Hey mod, can you check something?", timestamp: new Date(Date.now() - 86400000) },
                    { sender: "moderator1", text: "Sure, what do you need?", timestamp: new Date(Date.now() - 86300000) }
                ],
                "Saba Gvasalia:admin1": [
                    { sender: "admin1", text: "Saba, we need to discuss the new update", timestamp: new Date(Date.now() - 7200000) },
                    { sender: "Saba Gvasalia", text: "I'm available now", timestamp: new Date(Date.now() - 3600000) }
                ]
            },
            pendingFriendRequests: [],
            screenSharing: {
                active: false,
                stream: null,
                peerConnection: null
            },
            call: {
                active: false,
                incoming: false,
                caller: null,
                localStream: null,
                remoteStream: null,
                peerConnection: null,
                muted: false,
                videoOff: false
            }
        };

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('connectHubUsers', JSON.stringify(appState.users));
            localStorage.setItem('connectHubMessages', JSON.stringify(appState.messages));
        }

        // DOM Elements
        const elements = {
            authSection: document.getElementById('auth-section'),
            mainApp: document.getElementById('main-app'),
            currentUsername: document.getElementById('current-username'),
            currentUserRank: document.getElementById('current-user-rank'),
            friendsList: document.getElementById('friends-list'),
            friendRequestsList: document.getElementById('friend-requests-list'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input'),
            sendMessageBtn: document.getElementById('send-message'),
            currentChatName: document.getElementById('current-chat-name'),
            currentChatAvatar: document.getElementById('current-chat-avatar'),
            currentChatStatus: document.getElementById('current-chat-status'),
            chatHeader: document.getElementById('chat-header'),
            screenSharingContainer: document.getElementById('screen-sharing-container'),
            screenSharingVideo: document.getElementById('screen-sharing-video'),
            startScreenShareBtn: document.getElementById('start-screen-share'),
            stopScreenShareBtn: document.getElementById('stop-screen-share'),
            callContainer: document.getElementById('call-container'),
            localVideo: document.getElementById('local-video'),
            remoteVideo: document.getElementById('remote-video'),
            muteBtn: document.getElementById('mute-btn'),
            videoBtn: document.getElementById('video-btn'),
            incomingCall: document.getElementById('incoming-call'),
            callerName: document.getElementById('caller-name').querySelector('span'),
            startVideoCallBtn: document.getElementById('start-video-call')
        };

        // Form Toggle Functions
        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('reset-password-form').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('reset-password-form').classList.add('hidden');
            
            // Clear register form
            document.getElementById('reg-username').value = '';
            document.getElementById('reg-password').value = '';
            document.getElementById('reg-confirm-password').value = '';
            document.getElementById('reg-secret').value = '';
            document.getElementById('username-error').classList.add('hidden');
            document.getElementById('password-error').classList.add('hidden');
        }

        function showResetPassword() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('reset-password-form').classList.remove('hidden');
            
            // Clear reset form
            document.getElementById('reset-username').value = '';
            document.getElementById('reset-secret').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            document.getElementById('reset-password-error').classList.add('hidden');
        }

        // Auth Functions
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            const user = appState.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                if (user.rank === 'banned') {
                    showNotification('Error', 'This account has been banned', 'error');
                    return;
                }
                
                appState.currentUser = user;
                showNotification('Success', 'Logged in successfully', 'success');
                
                // Switch to main app
                elements.authSection.classList.add('hidden');
                elements.mainApp.classList.remove('hidden');
                
                // Initialize app
                initializeApp();
            } else {
                showNotification('Error', 'Invalid username or password', 'error');
            }
        }

        function handleRegister() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            const secretCode = document.getElementById('reg-secret').value;
            
            // Validate passwords match
            if (password !== confirmPassword) {
                document.getElementById('password-error').classList.remove('hidden');
                return;
            } else {
                document.getElementById('password-error').classList.add('hidden');
            }
            
            // Check if username exists
            const userExists = appState.users.some(u => u.username === username);
            if (userExists) {
                document.getElementById('username-error').classList.remove('hidden');
                return;
            } else {
                document.getElementById('username-error').classList.add('hidden');
            }
            
            // Add new user
            const newUser = {
                username,
                password,
                secretCode,
                verified: false,
                rank: 'user',
                profilePicture: null,
                online: true,
                friends: [],
                friendRequests: []
            };
            
            appState.users.push(newUser);
            saveState();
            showNotification('Success', 'Account created successfully', 'success');
            showLogin();
        }

        function handleResetPassword() {
            const username = document.getElementById('reset-username').value;
            const secretCode = document.getElementById('reset-secret').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                document.getElementById('reset-password-error').classList.remove('hidden');
                return;
            } else {
                document.getElementById('reset-password-error').classList.add('hidden');
            }
            
            // Find user and validate secret code
            const userIndex = appState.users.findIndex(u => u.username === username && u.secretCode === secretCode);
            
            if (userIndex !== -1) {
                appState.users[userIndex].password = newPassword;
                saveState();
                showNotification('Success', 'Password reset successfully', 'success');
                showLogin();
            } else {
                showNotification('Error', 'Invalid username or secret code', 'error');
            }
        }

        function handleLogout() {
            appState.currentUser.online = false;
            appState.currentUser = null;
            appState.currentChat = null;
            saveState();
            
            // End any active calls
            if (appState.call.active) {
                endCall();
            }
            
            elements.mainApp.classList.add('hidden');
            elements.authSection.classList.remove('hidden');
            showLogin();
        }

        // App Initialization
        function initializeApp() {
            // Set current user info
            elements.currentUsername.textContent = appState.currentUser.username;
            
            // Set user rank
            const rank = appState.currentUser.rank;
            elements.currentUserRank.textContent = rank;
            elements.currentUserRank.className = 'text-xs px-2 py-1 rounded-full bg-white bg-opacity-20';
            
            if (rank === 'owner') {
                elements.currentUserRank.classList.add('rank-owner');
            } else if (rank === 'admin') {
                elements.currentUserRank.classList.add('rank-admin');
            } else if (rank === 'moderator') {
                elements.currentUserRank.classList.add('rank-moderator');
            } else if (rank === 'tester') {
                elements.currentUserRank.classList.add('rank-tester');
            }
            
            // Set dark mode if enabled
            if (appState.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').className = 'fas fa-sun';
            }
            
            // Load friends list
            renderFriendsList();
            
            // Load friend requests
            renderFriendRequests();
            
            // Set online status
            appState.currentUser.online = true;
            saveState();
            
            // Check for pending friend requests
            checkFriendRequests();
            
            // Setup event listeners
            setupEventListeners();
        }

        // Friends List
        function renderFriendsList() {
            elements.friendsList.innerHTML = '';
            
            if (appState.currentUser.friends.length === 0) {
                elements.friendsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No friends yet</p>';
                return;
            }
            
            appState.currentUser.friends.forEach(friendUsername => {
                const friend = appState.users.find(u => u.username === friendUsername);
                if (friend) {
                    const friendElement = document.createElement('div');
                    friendElement.className = `flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${appState.currentChat === friendUsername ? 'bg-gray-200 dark:bg-gray-600' : ''}`;
                    friendElement.onclick = () => openChat(friendUsername);
                    
                    friendElement.innerHTML = `
                        <div class="relative">
                            <img src="https://ui-avatars.com/api/?name=${friend.username}" alt="${friend.username}" class="w-10 h-10 rounded-full">
                            <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${friend.online ? 'bg-green-500' : 'bg-gray-400'} border-2 border-white dark:border-gray-800"></span>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="flex items-center">
                                <span class="font-medium">${friend.username}</span>
                                ${friend.verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                                ${friend.rank === 'owner' ? '<span class="rank-owner text-xs ml-1">Owner</span>' : ''}
                                ${friend.rank === 'admin' ? '<span class="rank-admin text-xs ml-1">Admin</span>' : ''}
                                ${friend.rank === 'moderator' ? '<span class="rank-moderator text-xs ml-1">Mod</span>' : ''}
                                ${friend.rank === 'tester' ? '<span class="rank-tester text-xs ml-1">Tester</span>' : ''}
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${friend.online ? 'Online' : 'Offline'}</p>
                        </div>
                    `;
                    
                    elements.friendsList.appendChild(friendElement);
                }
            });
        }

        function renderFriendRequests() {
            elements.friendRequestsList.innerHTML = '';
            
            const incomingRequests = appState.users
                .filter(user => user.friendRequests.includes(appState.currentUser.username))
                .map(user => ({
                    username: user.username,
                    rank: user.rank,
                    verified: user.verified,
                    online: user.online
                }));
            
            if (incomingRequests.length === 0) {
                elements.friendRequestsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No pending requests</p>';
                return;
            }
            
            incomingRequests.forEach(request => {
                const requestElement = document.createElement('div');
                requestElement.className = 'flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700';
                
                requestElement.innerHTML = `
                    <div class="relative">
                        <img src="https://ui-avatars.com/api/?name=${request.username}" alt="${request.username}" class="w-10 h-10 rounded-full">
                        <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${request.online ? 'bg-green-500' : 'bg-gray-400'} border-2 border-white dark:border-gray-800"></span>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center">
                            <span class="font-medium">${request.username}</span>
                            ${request.verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Wants to be your friend</p>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="event.stopPropagation(); acceptFriendRequest('${request.username}')" class="p-1 text-green-500 hover:text-green-700 dark:hover:text-green-400">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="event.stopPropagation(); declineFriendRequest('${request.username}')" class="p-1 text-red-500 hover:text-red-700 dark:hover:text-red-400">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                elements.friendRequestsList.appendChild(requestElement);
            });
        }

        // Chat Functions
        function openChat(friendUsername) {
            appState.currentChat = friendUsername;
            
            // Update UI
            elements.currentChatName.textContent = friendUsername;
            elements.currentChatAvatar.src = `https://ui-avatars.com/api/?name=${friendUsername}`;
            
            const friend = appState.users.find(u => u.username === friendUsername);
            elements.currentChatStatus.textContent = friend.online ? 'Online' : 'Offline';
            elements.currentChatStatus.className = `text-xs ${friend.online ? 'text-green-500' : 'text-gray-500 dark:text-gray-400'}`;
            
            // Enable message input
            elements.messageInput.disabled = false;
            elements.sendMessageBtn.disabled = false;
            
            // Enable video call button if friend is online
            elements.startVideoCallBtn.disabled = !friend.online;
            
            // Highlight selected friend
            renderFriendsList();
            
            // Load messages
            loadMessages(friendUsername);
        }

        function loadMessages(friendUsername) {
            elements.messagesContainer.innerHTML = '';
            
            const chatKey = generateChatKey(appState.currentUser.username, friendUsername);
            const messages = appState.messages[chatKey] || [];
            
            if (messages.length === 0) {
                elements.messagesContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-comments text-4xl mb-2"></i>
                        <p>No messages yet. Say hello!</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const isCurrentUser = message.sender === appState.currentUser.username;
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
                
                messageElement.innerHTML = `
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isCurrentUser ? 'gradient-bg text-white rounded-br-none' : 'bg-white dark:bg-gray-600 rounded-bl-none'}">
                        ${!isCurrentUser ? `<div class="text-xs font-medium mb-1">${message.sender}</div>` : ''}
                        <div>${message.text}</div>
                        <div class="text-right mt-1">
                            <span class="text-xs opacity-70 ${isCurrentUser ? 'text-white' : 'text-gray-500 dark:text-gray-300'}">
                                ${formatTime(message.timestamp)}
                            </span>
                        </div>
                    </div>
                `;
                
                elements.messagesContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const messageText = elements.messageInput.value.trim();
            if (!messageText || !appState.currentChat) return;
            
            const chatKey = generateChatKey(appState.currentUser.username, appState.currentChat);
            if (!appState.messages[chatKey]) {
                appState.messages[chatKey] = [];
            }
            
            const newMessage = {
                sender: appState.currentUser.username,
                text: messageText,
                timestamp: new Date()
            };
            
            appState.messages[chatKey].push(newMessage);
            elements.messageInput.value = '';
            saveState();
            
            // Update UI
            loadMessages(appState.currentChat);
            
            // Simulate friend's response if they're online
            const friend = appState.users.find(u => u.username === appState.currentChat);
            if (friend && friend.online) {
                setTimeout(() => {
                    const responses = [
                        "Thanks for your message!",
                        "I'll get back to you soon.",
                        "That's interesting!",
                        "What are you up to?",
                        "Nice to hear from you!",
                        "How's it going?"
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const responseMessage = {
                        sender: friend.username,
                        text: randomResponse,
                        timestamp: new Date()
                    };
                    
                    appState.messages[chatKey].push(responseMessage);
                    saveState();
                    
                    // Only update UI if we're still in the same chat
                    if (appState.currentChat === friend.username) {
                        loadMessages(appState.currentChat);
                    }
                    
                    // Show notification if not in the chat
                    if (appState.currentChat !== friend.username) {
                        showNotification('New Message', `${friend.username}: ${randomResponse}`, 'info');
                    }
                }, 1000 + Math.random() * 3000); // Random delay between 1-4 seconds
            }
        }

        function generateChatKey(user1, user2) {
            return [user1, user2].sort().join(':');
        }

        // Friend Requests
        function showAddFriendModal() {
            document.getElementById('add-friend-modal').classList.remove('hidden');
        }

        function hideAddFriendModal() {
            document.getElementById('add-friend-modal').classList.add('hidden');
        }

        function sendFriendRequest() {
            const username = document.getElementById('add-friend-username').value.trim();
            const message = document.getElementById('add-friend-message').value.trim();
            
            if (!username) {
                showNotification('Error', 'Please enter a username', 'error');
                return;
            }
            
            // Check if user exists
            const user = appState.users.find(u => u.username === username);
            if (!user) {
                showNotification('Error', 'User not found', 'error');
                return;
            }
            
            // Check if already friends
            if (appState.currentUser.friends.includes(username) || user.friends.includes(appState.currentUser.username)) {
                showNotification('Error', 'You are already friends with this user', 'error');
                return;
            }
            
            // Check if request already sent
            if (user.friendRequests.includes(appState.currentUser.username)) {
                showNotification('Error', 'Friend request already sent', 'error');
                return;
            }
            
            // Add friend request
            user.friendRequests.push(appState.currentUser.username);
            saveState();
            
            // Show notification to recipient (simulated)
            if (user.online) {
                showNotification('Friend Request', `${appState.currentUser.username} wants to be your friend`, 'info');
            }
            
            showNotification('Success', 'Friend request sent', 'success');
            hideAddFriendModal();
        }

        function checkFriendRequests() {
            const incomingRequests = appState.users
                .filter(user => user.friendRequests.includes(appState.currentUser.username));
            
            if (incomingRequests.length > 0) {
                const request = incomingRequests[0];
                showFriendRequestPopup(request.username);
            }
        }

        function showFriendRequestPopup(username) {
            const popup = document.getElementById('friend-request-popup');
            const requestUser = appState.users.find(u => u.username === username);
            
            document.getElementById('request-username').textContent = username;
            document.getElementById('request-avatar').src = `https://ui-avatars.com/api/?name=${username}`;
            
            popup.classList.remove('hidden');
        }

        function hideFriendRequestPopup() {
            document.getElementById('friend-request-popup').classList.add('hidden');
        }

        function acceptFriendRequest(username) {
            // Remove from friend requests
            const requestUserIndex = appState.users.findIndex(u => u.username === username);
            if (requestUserIndex !== -1) {
                const requestUser = appState.users[requestUserIndex];
                requestUser.friendRequests = requestUser.friendRequests.filter(u => u !== appState.currentUser.username);
                
                // Add to friends list for both users
                if (!requestUser.friends.includes(appState.currentUser.username)) {
                    requestUser.friends.push(appState.currentUser.username);
                }
                
                if (!appState.currentUser.friends.includes(username)) {
                    appState.currentUser.friends.push(username);
                }
                
                // Update UI
                renderFriendsList();
                renderFriendRequests();
                saveState();
                
                showNotification('Success', `You are now friends with ${username}`, 'success');
            }
            
            hideFriendRequestPopup();
        }

        function declineFriendRequest(username) {
            // Remove from friend requests
            const requestUserIndex = appState.users.findIndex(u => u.username === username);
            if (requestUserIndex !== -1) {
                const requestUser = appState.users[requestUserIndex];
                requestUser.friendRequests = requestUser.friendRequests.filter(u => u !== appState.currentUser.username);
                
                // Update UI
                renderFriendRequests();
                saveState();
                
                showNotification('Info', `Friend request from ${username} declined`, 'info');
            }
            
            hideFriendRequestPopup();
        }

        // Screen Sharing
        async function startScreenShare() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: false
                });
                
                appState.screenSharing.active = true;
                appState.screenSharing.stream = stream;
                
                // Show screen sharing UI
                elements.screenSharingContainer.classList.remove('hidden');
                elements.screenSharingVideo.srcObject = stream;
                elements.startScreenShareBtn.classList.add('hidden');
                elements.stopScreenShareBtn.classList.remove('hidden');
                
                // In a real app, you would send the stream to the other user via WebRTC
                showNotification('Screen Sharing', 'You are now sharing your screen', 'success');
                
                // Handle when user stops sharing
                stream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };
            } catch (err) {
                console.error('Error sharing screen:', err);
                showNotification('Error', 'Failed to start screen sharing', 'error');
            }
        }

        function stopScreenShare() {
            if (appState.screenSharing.stream) {
                appState.screenSharing.stream.getTracks().forEach(track => track.stop());
                appState.screenSharing.stream = null;
            }
            
            appState.screenSharing.active = false;
            elements.screenSharingContainer.classList.add('hidden');
            elements.screenSharingVideo.srcObject = null;
            elements.startScreenShareBtn.classList.remove('hidden');
            elements.stopScreenShareBtn.classList.add('hidden');
            
            showNotification('Screen Sharing', 'Screen sharing stopped', 'info');
        }

        // Video Call Functions
        async function startVideoCall() {
            if (!appState.currentChat) {
                showNotification('Error', 'Select a friend to call', 'error');
                return;
            }
            
            const friend = appState.users.find(u => u.username === appState.currentChat);
            if (!friend.online) {
                showNotification('Error', 'Friend is offline', 'error');
                return;
            }
            
            try {
                // Get user media (camera and microphone)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                // Set up call state
                appState.call.active = true;
                appState.call.localStream = stream;
                appState.call.remoteStream = new MediaStream();
                
                // Show call UI
                elements.callContainer.classList.remove('hidden');
                elements.localVideo.srcObject = stream;
                elements.remoteVideo.srcObject = appState.call.remoteStream;
                
                // In a real app, you would establish a WebRTC connection here
                showNotification('Call', `Calling ${appState.currentChat}...`, 'info');
                
                // Simulate friend answering the call after 3 seconds
                setTimeout(() => {
                    if (appState.call.active) {
                        simulateIncomingAnswer();
                    }
                }, 3000);
                
            } catch (err) {
                console.error('Error starting call:', err);
                showNotification('Error', 'Failed to start call', 'error');
                endCall();
            }
        }

        function simulateIncomingAnswer() {
            // In a real app, this would be handled by WebRTC
            // Here we just simulate the friend answering
            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            }).then(stream => {
                elements.remoteVideo.srcObject = stream;
                showNotification('Call', `${appState.currentChat} answered your call`, 'success');
            }).catch(err => {
                console.error('Error simulating answer:', err);
                showNotification('Call', `${appState.currentChat} answered but couldn't start video`, 'error');
            });
        }

        function showIncomingCall(callerUsername) {
            appState.call.incoming = true;
            appState.call.caller = callerUsername;
            elements.callerName.textContent = callerUsername;
            elements.incomingCall.classList.remove('hidden');
        }

        function acceptCall() {
            appState.call.incoming = false;
            elements.incomingCall.classList.add('hidden');
            
            // Start the call
            startVideoCall();
        }

        function declineCall() {
            appState.call.incoming = false;
            elements.incomingCall.classList.add('hidden');
            showNotification('Call', 'Call declined', 'info');
        }

        function endCall() {
            if (appState.call.localStream) {
                appState.call.localStream.getTracks().forEach(track => track.stop());
                appState.call.localStream = null;
            }
            
            if (appState.call.remoteStream) {
                appState.call.remoteStream.getTracks().forEach(track => track.stop());
                appState.call.remoteStream = null;
            }
            
            appState.call.active = false;
            appState.call.incoming = false;
            elements.callContainer.classList.add('hidden');
            elements.localVideo.srcObject = null;
            elements.remoteVideo.srcObject = null;
            
            showNotification('Call', 'Call ended', 'info');
        }

        function toggleMute() {
            if (!appState.call.localStream) return;
            
            const audioTrack = appState.call.localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                appState.call.muted = !audioTrack.enabled;
                
                // Update button icon
                if (appState.call.muted) {
                    elements.muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                } else {
                    elements.muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                }
            }
        }

        function toggleVideo() {
            if (!appState.call.localStream) return;
            
            const videoTrack = appState.call.localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                appState.call.videoOff = !videoTrack.enabled;
                
                // Update button icon
                if (appState.call.videoOff) {
                    elements.videoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                } else {
                    elements.videoBtn.innerHTML = '<i class="fas fa-video"></i>';
                }
            }
        }

        // Utility Functions
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            localStorage.setItem('darkMode', appState.darkMode);
            
            if (appState.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('dark-mode-icon').className = 'fas fa-moon';
            }
        }

        function showNotification(title, message, type) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationIcon = document.getElementById('notification-icon');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // Set icon based on type
            notificationIcon.innerHTML = '';
            const icon = document.createElement('i');
            
            switch(type) {
                case 'success':
                    icon.className = 'fas fa-check-circle text-green-500';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle text-red-500';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle text-yellow-500';
                    break;
                default:
                    icon.className = 'fas fa-info-circle text-blue-500';
            }
            
            notificationIcon.appendChild(icon);
            notification.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.add('hidden');
        }

        function showChatOptions() {
            // In a real app, this would show chat options like mute, block, etc.
            showNotification('Info', 'Chat options would appear here', 'info');
        }

        // Event Listeners
        function setupEventListeners() {
            // Send message on Enter key
            elements.messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Send message on button click
            elements.sendMessageBtn.addEventListener('click', sendMessage);
            
            // Search users
            document.getElementById('search-users').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const friends = document.querySelectorAll('#friends-list > div');
                
                friends.forEach(friend => {
                    const username = friend.querySelector('.font-medium').textContent.toLowerCase();
                    if (username.includes(searchTerm)) {
                        friend.classList.remove('hidden');
                    } else {
                        friend.classList.add('hidden');
                    }
                });
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            showLogin();
            
            // Add event listeners for form submissions
            document.getElementById('login-username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('reg-username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            document.getElementById('reg-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            document.getElementById('reg-confirm-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            document.getElementById('reg-secret').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            document.getElementById('reset-username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleResetPassword();
            });
            
            document.getElementById('reset-secret').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleResetPassword();
            });
            
            document.getElementById('new-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleResetPassword();
            });
            
            document.getElementById('confirm-new-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleResetPassword();
            });
        });
    </script>
</body>
</html>
